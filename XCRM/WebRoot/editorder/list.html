<script>
	$(function() {
		
		var freshEditOrderUI = function(){
			 var r = window.location.search;
	     var orderno = r.substring(r.indexOf("?")+1,r.length);
	     location.href = '/editorder?' + orderno;
		}
		
		$('.create.btn.btn-primary').on('click', function() {
			 var r = window.location.search;
        var orderno = r.substring(r.indexOf("?")+1,r.length);
        location.href = '/search?edit' + orderno;
		});
		
		$('.del-item').on('click', function() {
			var that = $(this);
			var id = that.attr('data');
			$.ajax({
				type : "get",
				url : '/cartlist/cancel?id=' + id,
				success : function(data, status) {
					if (status == "success") {
						freshEditOrderUI();
					}
				}
			});
		});
		
    $('.resume-item').on('click', function() {
        var that = $(this);
        var id = that.attr('data');
        $.ajax({
          type : "get",
          url : '/cartlist/resume?id=' + id,
          success : function(data, status) {
            if (status == "success") {
            	freshEditOrderUI();
            }
          }
        });
      });
		
		var auto_calc_amount = function(){
			var amount = 0;
      for (var i = 0; i < $('.sum').length; i++) {
        amount += parseFloat($($('.sum')[i]).html());
      }
      $('.amount').html(amount);
      var discount =$('#discount').val();
      if(discount<=0 || discount > 100){
        showAlert("输入的折扣值不能大于100小于0!!!");
        $('#discount').val(100);
        $('#price').val(amount*100/100);
        return;
      }
      if(!discount) discount = 100;
      $('#price').val( (amount*discount/100).toFixed(2));
		};
		
		var calc_amount = function() {
			var amount = 0;
			for (var i = 0; i < $('.sum').length; i++) {
				amount += parseFloat($($('.sum')[i]).html());
			}
			$('.amount').html(amount);
			var discount =$('#discount').val();
			if(discount<=0 || discount > 100){
				showAlert("输入的折扣值不能大于100小于0!!!");
				$('#discount').val(100);
				$('#price').val(amount*100/100);
				return;
			}
			if(!discount) discount = 100;
		};
		
		$("#discount").on('input',function(e){  
			auto_calc_amount();
		});  
		
    var calc_disacount = function() {
        var price =$('#price').val();
        var amount = 0;
        for (var i = 0; i < $('.sum').length; i++) {
          amount += parseFloat($($('.sum')[i]).html());
        }
        $('#discount').val( (price/amount * 100).toFixed(2));
      };
	      
     $("#price").on('input',function(e){  
   	  calc_disacount();
     });  
		
		var change_comments=function(){
			if($(this).has('textarea').length==0){
				var comments=$.trim($(this).html());
				$(this).empty();
				$(this).html('<textarea placeholder="请添加订单项说明" class="form-control" cols="8" rows="2"></textarea>');
				$(this).find('textarea').html(comments);
				$(this).find('textarea').on('blur',update_comments);
				$(this).find('textarea').focus();
			}
		}
		
		var update_comments = function(){
			var that = $(this);
			var comments = $(this).val();
			var id = $(this).parents('tr').find('input').val();
			if(!comments){
				return;
			}
			$.ajax({
				type:'post',
				url:'/cartlist/updatecomments',
				data:{'id':id,'comments':comments},
				success:function(){
					var td = that.parents('td');
					td.empty();
					td.html(comments);
					td.on('click',change_comments);
				}
			});
		}
		
		$('.comments-td').on('click',change_comments);
		$('.comments-td textarea').on('blur',update_comments);
		
		calc_amount();
	});
</script>

<style>
th, td {
	width: 10%;
}

table {
	table-layout: fixed;
	word-wrap: break-word;
}

.comments-td, .comments-th {
	width: 20%;
}
</style>

<table class="table table-striped table-hover">
	<thead>
		<tr>
			<th>图片</th>
			<th>产品名称</th>
			<th>数量</th>
			<th>价格</th>
			<th>小计</th>
			<th class="comments-th required">商品备注</th>
			<th>操作</th>
		</tr>
	</thead>
	<#list list as item>
	<tr>
		<input type="hidden" value="${item.id}" class="itemid" />
		<td><img width="80px" height="80px"
			src='${(item.filename??)?string((prdimg_path+"/"+item.pid+"/"+((item.filename!"")?split(","))[0]),"/img/placehold.jpg")}' />
		</td>
		<#if item.status??&&item.status == 2>
			<td><s>${item.name}</s></td>
			<td><s>${item.num}</s></td>
			<td><s>${item.price}</s></td>
			<td class="sum">${0}</td>
	    <td class="comments-td"><#if item.comments??><s>${item.comments}</s>
	      <#else><textarea placeholder="请添加商品说明" class="form-control" cols="8"
	        rows="2"></textarea></#if>
	    <td><a class="resume-item" data="${item.id}"
        href="javascript:void(0);">恢复</a></td>
		<#else>
			<td>${item.name}</td>
	    <td>${item.num}</td>
	    <td>${item.price}</td>
			<td class="sum">${item.price*item.num}</td>
	    <td class="comments-td"><#if item.comments??>${item.comments}
	      <#else><textarea placeholder="请添加商品说明" class="form-control" cols="8"
	        rows="2"></textarea></#if>
	    </td>
	    <td><a class="del-item" data="${item.id}"
	      href="javascript:void(0);">取消</a></td>
		</#if>
	</tr>
	</#list>

</table>

<div class="col-md-12"
  style="text-align: left; padding: 10px; border-top: 1px solid #ddd">
    <div>
      <textarea placeholder="请添加订单说明" id="ordercomments"
        class="form-control" rows="2"></textarea>
    </div>
</div>

<div class="col-md-12"
	style="text-align: left; padding: 10px; border-top: 1px solid #ddd">
	
	<div class="col-md-2" style="float: left; font-weight: bold">
		<span>输入折扣(百分比):</span> <input type="number" class="form-control"
			id="discount" value="100" min="1" max="100" />
	</div>
	
	<div class="col-md-3 col-md-offset-5" style="text-align: right; font-weight: bold">
		<div>
			<span>总价:</span> <span class="amount" style="color: #df3033; font-size: 18px"></span>
			<span>   </span>
			<span>已付:</span> <span style="color: #df3033; font-size: 18px">${paid!}</span>
		</div>
		<div class="input-group">
			<span class="input-group-addon">成交价: </span> 
			<input type="text" class="form-control" id="price" name="price" value="${dealprice!}"/>
		</div>
	</div>

	<div class="col-md-2"
		style="float: right;font-size: 18px; background-color: #df3033; text-align: center;">
		<a id="changeorder" class="sc-btn">确定修改</a>
	</div>
</div>